#!/bin/zsh

summary() {
    local files=(os.txt shell.txt term.txt)

    for file ($files) {
        local -A tmp tmpr
        local all=0

        while {read line} {
            name=${line#* }
            (($+tmp[$name])) || tmp[$name]=0

            ((tmp[$name]++, all++))
        } < data/$file

        for k v (${(kv)tmp}) {
           tmpr[$v]=$k
        }

        for k (${(Onk)tmpr}) {
            echo "$tmpr[$k] <br> $k / $all <br> $(printf '%.3f' $((100.0 * k / all)))%"
        } > $file

        unset tmp tmpr
    }

    paste -d ':' $files
    rm $files
}

before='''<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <title>asciinema statistics</title>
  </head>
  <body lang="en" style="background-color:#000000;">
    <h1 align="center" style="color:#FFFFFF;">asciinema statistics (%s)</h1>

    <table class="table table-dark">
      <thead>
        <tr>
          <th scope="col"></th>
          <th scope="col">OS</th>
          <th scope="col">SHELL</th>
          <th scope="col">TERM</th>
        </tr>
      </thead>
      <tbody>'''

after='''
      </tbody>
    </table>

  </body>
</html>'''

template='''
        <tr>
          <th scope="row">%s</th>
          <td>%s</td>
          <td>%s</td>
          <td>%s</td>
        </tr>
'''

printf $before "$(date +'%Y-%m-%d %H:%M:%S')" > index.html

index=0
summary | while {read line} {
    printf $template $((++index)) "${(s/:/)line}" >> index.html
}

echo $after >> index.html
